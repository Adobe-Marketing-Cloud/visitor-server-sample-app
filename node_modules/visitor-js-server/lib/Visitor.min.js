"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=Visitor;var _visitorJsShared=require("visitor-js-shared");var _visitorJsShared2=_interopRequireDefault(_visitorJsShared);var _cookies=require("./cookies");var _visitorPayload=require("./visitor-payload");var _visitorPayload2=_interopRequireDefault(_visitorPayload);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function Visitor(){var _this=this;var orgID=arguments.length<=0||arguments[0]===undefined?required("Visitor requires an Org ID!"):arguments[0];orgID=normalizeOrgId(orgID);var state={};this.generateSupplementalID=function(){var sdid=_visitorJsShared2.default.generateSupplementalID();Object.assign(state,{sdid:sdid});return sdid};this.generateVisitorPayload=function(amcvCookie){var sdid=_this.generateSupplementalID();var amcvValues=(0,_cookies.parseValuesFromAmcvCookie)(amcvCookie,keysForAmcvValues);var customerIDs=state.customerIDs;return(0,_visitorPayload2.default)({sdid:sdid,amcvValues:amcvValues,customerIDs:customerIDs})};this.getState=function(){return _defineProperty({},orgID,state)};this.setCustomerIDs=function(){var customerIDs=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];Object.assign(state,{customerIDs:customerIDs})}}var keysForAmcvValues=["MCMID","MCAAMB","MCAAMLH"];var normalizeOrgId=function normalizeOrgId(orgID){return orgID.indexOf("@")<0?orgID+"@AdobeOrg":orgID};var required=function required(msg){throw new Error(msg)};module.exports=exports["default"];"use strict";Object.defineProperty(exports,"__esModule",{value:true});var cookies={parseValuesFromAmcvCookie:function parseValuesFromAmcvCookie(){var cookie=arguments.length<=0||arguments[0]===undefined?"":arguments[0];var values=arguments.length<=1||arguments[1]===undefined?[]:arguments[1];var tokens=decodeURI(cookie).split("|");return values.reduce(function(amcvVals,val){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=tokens[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var param=_step.value;if(param.indexOf(val)===0){var indexOfParam=tokens.indexOf(param);amcvVals[val]=tokens[indexOfParam+1];return amcvVals}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}},{})}};exports.default=cookies;module.exports=exports["default"];"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}var payloadToTargetKeyMap={MCMID:"marketingCloudVisitorId",MCAAMB:"mboxAAMB",MCAAMLH:"mboxMCGLH",sdid:"mboxMCSDID",puuid:"mboxAAMDPUUID",pid:"mboxAAMDPID",authStateId:"vst.authStateId",authState:"vst.authState.authState"};function createTargetSchema(){return{marketingCloudVisitorId:undefined,mboxParameters:{mboxAAMB:undefined,mboxMCGLH:undefined,mboxAAMDPUUID:undefined,mboxAAMDPID:undefined,"vst.authStateId":undefined,"vst.authState.authState":undefined,mboxMCSDID:undefined}}}function renameKeys(obj,keysMap){return Object.assign.apply(Object,[{}].concat(_toConsumableArray(Object.keys(obj).map(function(key){return _defineProperty({},keysMap[key],obj[key])}))))}var isObject=function isObject(val){return val===Object(val)};var filterFalsyProps=function filterFalsyProps(obj){return JSON.parse(JSON.stringify(obj))};function populate(schema,objWithValues){Object.keys(schema).forEach(function(key){if(isObject(schema[key])){populate(schema[key],objWithValues)}else if(objWithValues.hasOwnProperty(key)){schema[key]=objWithValues[key]}});return filterFalsyProps(schema)}function adapt(obj){var objWithTargetKeys=renameKeys(obj,payloadToTargetKeyMap);var targetSchema=createTargetSchema();return populate(targetSchema,objWithTargetKeys)}exports.default={adapt:adapt};module.exports=exports["default"];"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=createVisitorPayload;var _targetAdapter=require("./target-adapter");var _targetAdapter2=_interopRequireDefault(_targetAdapter);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function adaptCustomerIDsToPayload(){var customerIDs=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];var customerIDsKeys=Object.keys(customerIDs);var pid=customerIDsKeys.length?customerIDsKeys[0]:undefined;var puuid=pid?customerIDs[pid].id:undefined;return{pid:pid,puuid:puuid}}function createVisitorPayload(_ref){var sdid=_ref.sdid;var _ref$amcvValues=_ref.amcvValues;var amcvValues=_ref$amcvValues===undefined?{}:_ref$amcvValues;var customerIDs=_ref.customerIDs;var payload=Object.assign(Object.create(null),{sdid:sdid},amcvValues,adaptCustomerIDsToPayload(customerIDs));return _targetAdapter2.default.adapt(payload)}module.exports=exports["default"];
