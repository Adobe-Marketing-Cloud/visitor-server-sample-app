const test = require("tape");
const targetAdapter = require("../src/target-adapter");

const visitorPayload1 = {
    MCMID: "123123",
    MCAAMLH: "6",
    MCAAMB: "Nyduiniu_908",
    sdid: "556677",
    puuid: "aabbcc",
    pid: "9",
    authStateId: 1,
    authState: 0
};

const visitorPayload2 = {
    MCAAMLH: "6",
    MCAAMB: "Nyduiniu_908",
    sdid: "556677",
    puuid: "aabbcc",
    pid: "9",
    authStateId: 1,
    authState: 0
};

const visitorPayload3 = {
    sdid: "556677"
};

test("Target Adapter Interface:", (t) => {
    t.ok(targetAdapter.adapt, "adapt");
    t.end();
});

test("Calling adapt with a full payload", (t) => {
    var targetAdaptedPayload = targetAdapter.adapt(visitorPayload1);
    
    t.deepEquals(targetAdaptedPayload, {
        "marketingCloudVisitorId": "123123",
        "mboxParameters": {
            "mboxMCGLH": "6",
            "mboxAAMB": "Nyduiniu_908",
            "mboxMCSDID": "556677",
            "mboxAAMDPUUID": "aabbcc",
            "mboxAAMDPID": "9",
            "vst.authStateId": 1,
            "vst.authState.authState": 0
        }
    });
    
    t.end();
});

test("Calling adapt with a payload with no MCMID", (t) => {
    var targetAdaptedPayload = targetAdapter.adapt(visitorPayload2);
    
    t.deepEquals(targetAdaptedPayload, {
        "mboxParameters": {
            "mboxMCGLH": "6",
            "mboxAAMB": "Nyduiniu_908",
            "mboxMCSDID": "556677",
            "mboxAAMDPUUID": "aabbcc",
            "mboxAAMDPID": "9",
            "vst.authStateId": 1,
            "vst.authState.authState": 0
        }
    });
    
    t.end();
});

test("Calling adapt with a payload with a SDID only", (t) => {
    var targetAdaptedPayload = targetAdapter.adapt(visitorPayload3);
    
    t.deepEquals(targetAdaptedPayload, {
        "mboxParameters": {
            "mboxMCSDID": "556677"
        }
    });
    
    t.end();
});
