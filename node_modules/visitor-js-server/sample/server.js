var cookie = require("cookie");
var express = require("express");
var app = express();

var Visitor = require("../lib/Visitor");
var visitor = new Visitor("12345sampleapp");

function generatePage(state, payload) {
    var head = "<script>var visitorServerState = " + state + ";</script>";
    return "<html><head>" + head + "</head><body><h1>State and payload: " + state + ", <br/ ><br/>" + payload + "</h1></body>";
}

app.get("/", function (req, res) {
    var cookies = cookie.parse(req.headers.cookie || "");
    var amcvCookie = cookies.AMCV;

    // Visitor ID Payload: Either a SDID if no AMCV, othewise parse the cookie content into an object.
    var visitorPayload = visitor.generateVisitorPayload(amcvCookie);
    // TODO Here: Make Target call by passing the visitor payload.

    var serverState = visitor.getState();

    var pageHtml = generatePage(JSON.stringify(serverState), JSON.stringify(visitorPayload));
    
    // MOCK: Create AMCV cookie! This would be done by the VisitorAPI.js client side!!
    if (!amcvCookie) {
        var oneWeekInSecond = 60 * 60 * 24 * 7;
        res.cookie("AMCV", "MCMID-3143515|1234|MCAAMB|abcd1234|MCAAMLH|9", { maxAge: oneWeekInSecond });
    }

    res.set({
        "Content-Type": "text/html",
        "Content-Length": pageHtml.length,
        "Expires": new Date().toUTCString()
    });

    res.status(200).send(pageHtml);
});

app.listen(3000, function () {
    /* eslint-disable no-console */
    console.log("Listening on port 3000 and watching!");
    /* eslint-enable no-console */
});
